#!/bin/bash
set -euo pipefail

RED='\033[0;31m'
MUTED='\033[0;2m'
NC='\033[0m'

usage() {
  cat <<EOF
Sentry CLI Installer

Usage: install [options]

Options:
    -h, --help              Display this help message
    -v, --version <version> Install a specific version (e.g., 0.2.0)
        --no-modify-path    Don't modify shell config files (.zshrc, .bashrc, etc.)

Environment Variables:
    SENTRY_INSTALL_DIR      Override the installation directory

Examples:
    curl -fsSL https://cli.sentry.dev/install | bash
    curl -fsSL https://cli.sentry.dev/install | bash -s -- --version 0.2.0
    SENTRY_INSTALL_DIR=~/.local/bin curl -fsSL https://cli.sentry.dev/install | bash
EOF
}

requested_version=""
no_modify_path=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help) usage; exit 0 ;;
    -v|--version)
      if [[ -n "${2:-}" ]]; then
        requested_version="$2"
        shift 2
      else
        echo -e "${RED}Error: --version requires a version argument${NC}"
        exit 1
      fi
      ;;
    --no-modify-path)
      no_modify_path=true
      shift
      ;;
    *) shift ;;
  esac
done

# Detect OS
case "$(uname -s)" in
  Darwin*) os="darwin" ;;
  Linux*) os="linux" ;;
  MINGW*|MSYS*|CYGWIN*) os="windows" ;;
  *) echo -e "${RED}Unsupported OS: $(uname -s)${NC}"; exit 1 ;;
esac

# Detect architecture
arch=$(uname -m)
case "$arch" in
  x86_64) arch="x64" ;;
  aarch64|arm64) arch="arm64" ;;
  *) echo -e "${RED}Unsupported architecture: $arch${NC}"; exit 1 ;;
esac

# Validate supported combinations
suffix=""
if [[ "$os" == "windows" ]]; then
  suffix=".exe"
  if [[ "$arch" != "x64" ]]; then
    echo -e "${RED}Unsupported: windows-$arch (only windows-x64 is supported)${NC}"
    exit 1
  fi
fi

# Resolve version
if [[ -z "$requested_version" ]]; then
  version=$(curl -fsSL https://api.github.com/repos/getsentry/cli/releases/latest | sed -n 's/.*"tag_name": *"\([^"]*\)".*/\1/p')
  if [[ -z "$version" ]]; then
    echo -e "${RED}Failed to fetch latest version${NC}"
    exit 1
  fi
else
  version="$requested_version"
fi

# Strip leading 'v' if present (releases use version without 'v' prefix)
version="${version#v}"
filename="sentry-${os}-${arch}${suffix}"
url="https://github.com/getsentry/cli/releases/download/${version}/${filename}"

# Determine install directory
# Priority:
# 1. SENTRY_INSTALL_DIR environment variable (if set and writable)
# 2. ~/.local/bin (if exists AND in $PATH)
# 3. ~/bin (if exists AND in $PATH)
# 4. ~/.sentry/bin (fallback, will modify PATH)
needs_path_modification=false
install_dir=""

if [[ -n "${SENTRY_INSTALL_DIR:-}" ]]; then
  # User explicitly specified install directory
  install_dir="$SENTRY_INSTALL_DIR"
  if [[ ! -d "$install_dir" ]]; then
    mkdir -p "$install_dir" 2>/dev/null || true
  fi
  if [[ ! -w "$install_dir" ]]; then
    echo -e "${RED}Error: Cannot write to $install_dir${NC}"
    echo -e "${MUTED}Try running with sudo or choose a different directory.${NC}"
    exit 1
  fi
  # Check if it's in PATH
  if ! echo "$PATH" | tr ':' '\n' | grep -Fxq "$install_dir"; then
    needs_path_modification=true
  fi
elif [[ -d "$HOME/.local/bin" ]] && echo "$PATH" | tr ':' '\n' | grep -Fxq "$HOME/.local/bin"; then
  install_dir="$HOME/.local/bin"
elif [[ -d "$HOME/bin" ]] && echo "$PATH" | tr ':' '\n' | grep -Fxq "$HOME/bin"; then
  install_dir="$HOME/bin"
else
  install_dir="$HOME/.sentry/bin"
  needs_path_modification=true
fi

install_path="${install_dir}/sentry${suffix}"

# Create directory if needed
mkdir -p "$install_dir"

# Download binary
echo -e "${MUTED}Downloading sentry v${version}...${NC}"
curl -fsSL --progress-bar "$url" -o "$install_path"
chmod +x "$install_path"

# Record installation metadata
"$install_path" cli record-install --method curl 2>/dev/null || true

# Add to PATH (helper function)
add_to_path() {
  local config_file=$1
  local command=$2

  if grep -Fxq "$command" "$config_file"; then
    echo -e "${MUTED}PATH already configured in ${NC}$config_file"
  elif [[ -w $config_file ]]; then
    echo -e "\n# sentry" >> "$config_file"
    echo "$command" >> "$config_file"
    echo -e "${MUTED}Added ${NC}sentry ${MUTED}to PATH in ${NC}$config_file"
  else
    echo -e "${MUTED}Manually add the directory to $config_file (or similar):${NC}"
    echo "  $command"
  fi
}

# Only modify PATH if needed (fallback to ~/.sentry/bin or custom non-PATH dir)
if [[ "$needs_path_modification" == "true" ]] && [[ "$no_modify_path" != "true" ]]; then
  XDG_CONFIG_HOME=${XDG_CONFIG_HOME:-$HOME/.config}

  current_shell=$(basename "${SHELL:-sh}")
  case $current_shell in
    fish)
      config_files=("$XDG_CONFIG_HOME/fish/config.fish")
      ;;
    zsh)
      config_files=("$HOME/.zshrc" "$HOME/.zshenv" "$XDG_CONFIG_HOME/zsh/.zshrc" "$XDG_CONFIG_HOME/zsh/.zshenv")
      ;;
    bash)
      config_files=("$HOME/.bash_profile" "$HOME/.bashrc" "$HOME/.profile" "$XDG_CONFIG_HOME/bash/.bash_profile" "$XDG_CONFIG_HOME/bash/.bashrc")
      ;;
    ash|sh)
      config_files=("$HOME/.profile" "/etc/profile")
      ;;
    *)
      config_files=("$HOME/.bash_profile" "$HOME/.bashrc" "$HOME/.profile")
      ;;
  esac

  config_file=""
  for file in "${config_files[@]}"; do
    if [[ -f $file ]]; then
      config_file=$file
      break
    fi
  done

  if [[ -z $config_file ]]; then
    echo -e "${MUTED}No config file found. Manually add to PATH:${NC}"
    case $current_shell in
      fish)
        echo "  fish_add_path \"$install_dir\""
        ;;
      *)
        echo "  export PATH=\"$install_dir\":\$PATH"
        ;;
    esac
  else
    case $current_shell in
      fish)
        add_to_path "$config_file" "fish_add_path \"$install_dir\""
        ;;
      *)
        add_to_path "$config_file" "export PATH=\"$install_dir\":\$PATH"
        ;;
    esac
  fi
elif [[ "$needs_path_modification" == "true" ]] && [[ "$no_modify_path" == "true" ]]; then
  echo -e "${MUTED}Skipping PATH modification. Manually add to your shell config:${NC}"
  current_shell=$(basename "${SHELL:-sh}")
  case $current_shell in
    fish)
      echo "  fish_add_path \"$install_dir\""
      ;;
    *)
      echo "  export PATH=\"$install_dir\":\$PATH"
      ;;
  esac
fi

# GitHub Actions support
if [[ -n "${GITHUB_ACTIONS:-}" ]] && [[ "${GITHUB_ACTIONS}" == "true" ]] && [[ -n "${GITHUB_PATH:-}" ]]; then
  echo "$install_dir" >> "$GITHUB_PATH"
  echo -e "${MUTED}Added to \$GITHUB_PATH${NC}"
fi

# Success message
echo ""
echo -e "Installed ${NC}sentry v${version}${MUTED} to ${NC}${install_path}"
echo ""
if [[ "$needs_path_modification" == "true" ]]; then
  echo -e "${MUTED}Get started (restart your shell or open a new terminal):${NC}"
else
  echo -e "${MUTED}Get started:${NC}"
fi
echo "  sentry --help"
echo ""
echo -e "${MUTED}https://cli.sentry.dev${NC}"
