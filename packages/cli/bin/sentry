#!/usr/bin/env node

const childProcess = require("child_process")
const fs = require("fs")
const path = require("path")
const os = require("os")

function run(target) {
  const result = childProcess.spawnSync(target, process.argv.slice(2), {
    stdio: "inherit",
  })
  if (result.error) {
    console.error(result.error.message)
    process.exit(1)
  }
  const code = typeof result.status === "number" ? result.status : 0
  process.exit(code)
}

const platformMap = {
  darwin: "darwin",
  linux: "linux",
  win32: "windows",
}

const archMap = {
  x64: "x64",
  arm64: "arm64",
}

let platform = platformMap[os.platform()]
if (!platform) {
  console.error(`Unsupported platform: ${os.platform()}`)
  process.exit(1)
}

let arch = archMap[os.arch()]
if (!arch) {
  console.error(`Unsupported architecture: ${os.arch()}`)
  process.exit(1)
}

const packageName = `sentry-${platform}-${arch}`
const binaryName = platform === "windows" ? "sentry.exe" : "sentry"

function findBinary(startDir) {
  let current = startDir
  for (;;) {
    const modules = path.join(current, "node_modules")
    if (fs.existsSync(modules)) {
      const candidate = path.join(modules, packageName, "bin", binaryName)
      if (fs.existsSync(candidate)) {
        return candidate
      }
    }
    const parent = path.dirname(current)
    if (parent === current) {
      return null
    }
    current = parent
  }
}

const scriptDir = path.dirname(fs.realpathSync(__filename))
const resolved = findBinary(scriptDir)

if (!resolved) {
  console.error(
    `Could not find the sentry binary for your platform.\n` +
    `Expected package: ${packageName}\n` +
    `You can try manually installing it: npm install ${packageName}`
  )
  process.exit(1)
}

run(resolved)
