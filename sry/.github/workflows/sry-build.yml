name: Build sry CLI

on:
  push:
    branches: [main]
    paths:
      - 'src/sry/**'
      - '.github/workflows/sry-build.yml'
  pull_request:
    paths:
      - 'src/sry/**'
      - '.github/workflows/sry-build.yml'
  workflow_dispatch:

concurrency:
  group: sry-${{ github.ref_name || github.sha }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash
    working-directory: src/sry

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'push' && github.ref_name == 'main' && 'Production' || 'Preview' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Setup Codesign Dependencies
        if: github.event_name == 'push' && github.ref_name == 'main'
        env:
          APPLE_CERT_DATA: ${{ secrets.CSC_LINK }}
          APPLE_API_KEY: ${{ secrets.APPLE_API_KEY }}
        run: |
          curl -L 'https://github.com/indygreg/apple-platform-rs/releases/download/apple-codesign%2F0.29.0/apple-codesign-0.29.0-x86_64-unknown-linux-musl.tar.gz' -o 'rcodesign.tar.gz'
          echo 'dbe85cedd8ee4217b64e9a0e4c2aef92ab8bcaaa41f20bde99781ff02e600002 rcodesign.tar.gz' | sha256sum -c
          tar -xzf rcodesign.tar.gz --strip-components=1
          sudo mv rcodesign /usr/local/bin/rcodesign
          rm rcodesign.tar.gz
          # Export certs
          echo "$APPLE_CERT_DATA" | base64 --decode > /tmp/certs.p12
          echo 'APPLE_CERT_PATH=/tmp/certs.p12' >> $GITHUB_ENV
          echo "$APPLE_API_KEY" | base64 -d > /tmp/apple_key.json
          cat /tmp/apple_key.json | jq .private_key -r > /tmp/apple_key.pem
          echo "APPLE_API_KEY_ISSUER_ID=$(cat /tmp/apple_key.json | jq .issuer_id -r | tr -d '\n\r')" >> $GITHUB_ENV
          echo "APPLE_API_KEY_ID=$(cat /tmp/apple_key.json | jq .key_id -r | tr -d '\n\r')" >> $GITHUB_ENV
          echo "APPLE_API_KEY_P8_PATH=/tmp/apple_key.pem" >> $GITHUB_ENV
          echo 'APPLE_API_KEY_PATH=/tmp/apple_key.json' >> $GITHUB_ENV

      - name: Build binaries
        env:
          APPLE_CERT_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_TEAM_ID: ${{ vars.TEAMID }}
          FOSSILIZE_PLATFORMS: linux-x64,linux-arm64,win-x64,darwin-x64,darwin-arm64
          FOSSILIZE_SIGN: ${{ github.event_name == 'push' && github.ref_name == 'main' && 'y' || 'n' }}
        run: bun run build:all

      - name: Smoke test
        env:
          SRY_BINARY: ${{ github.workspace }}/src/sry/dist-bin/sry-${{ runner.os }}-${{ runner.arch }}
        run: |
          # Lowercase the binary name because runner.os and runner.arch are uppercase
          SRY_BINARY=$(echo "$SRY_BINARY" | tr '[:upper:]' '[:lower:]')
          [ -f "$SRY_BINARY" ]
          $SRY_BINARY --help && echo "sry binary ran successfully"

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: sry-binaries
          if-no-files-found: error
          path: src/sry/dist-bin/sry-*

