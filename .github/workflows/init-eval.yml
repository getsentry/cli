name: Init Eval

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to evaluate (or 'all')"
        required: true
        default: all
        type: choice
        options:
          - all
          - express
          - nextjs
          - python-fastapi
          - python-flask
          - react-vite
          - sveltekit

jobs:
  eval:
    name: Eval ${{ matrix.platform }}
    runs-on: ubuntu-latest
    environment: init-eval
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ inputs.platform == 'all'
          && fromJson('["express","nextjs","python-fastapi","python-flask","react-vite","sveltekit"]')
          || fromJson(format('["{0}"]', inputs.platform)) }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - uses: actions/cache@v4
        id: cache
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('bun.lock', 'patches/**') }}
      - if: steps.cache.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile
      - name: Run eval
        env:
          MASTRA_API_URL: ${{ secrets.MASTRA_API_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: bun test ./test/init-eval/${{ matrix.platform }}.eval.test.ts --timeout 600000
